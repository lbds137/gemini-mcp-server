#!/bin/bash
#
# Pre-push hook for council-mcp-server
# Runs comprehensive checks before allowing push to remote
#
# Install with: ./scripts/install-hooks.sh
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Pre-push checks starting...${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Track failures
FAILED=0

# Function to run a check
run_check() {
    local name="$1"
    local cmd="$2"

    echo -e "${YELLOW}Running: ${name}${NC}"
    if eval "$cmd"; then
        echo -e "${GREEN}✓ ${name} passed${NC}"
        echo ""
    else
        echo -e "${RED}✗ ${name} failed${NC}"
        echo ""
        FAILED=1
    fi
}

# Change to project root
cd "$(git rev-parse --show-toplevel)"

# Activate virtual environment if it exists
if [ -f ".venv/bin/activate" ]; then
    source .venv/bin/activate
elif [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
fi

# Run linting (fast)
run_check "Ruff linting" "ruff check src/ tests/ --quiet || flake8 src/ tests/ --quiet"

# Run formatting check (fast)
run_check "Black formatting" "black --check src/ tests/ --quiet"

# Run import order check (fast)
run_check "isort import order" "isort --check-only src/ tests/ --quiet"

# Run type checking (medium)
run_check "mypy type checking" "mypy src/ --no-error-summary"

# Run tests (comprehensive)
run_check "pytest test suite" "pytest tests/ -v --tb=short -q"

# Summary
echo -e "${BLUE}========================================${NC}"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}  All pre-push checks passed!${NC}"
    echo -e "${BLUE}========================================${NC}"
    exit 0
else
    echo -e "${RED}  Pre-push checks failed!${NC}"
    echo -e "${RED}  Push aborted. Fix issues and try again.${NC}"
    echo -e "${BLUE}========================================${NC}"
    exit 1
fi
